import { NextResponse } from 'next/server'
import Twilio from 'twilio'
import { connectDB } from '@/lib/db'
import User from '@/models/User'
import jwt from 'jsonwebtoken'
export async function POST(req){ const { phone, code } = await req.json(); if (!phone || !code) return NextResponse.json({ message:'phone+code required' }, { status:400 }); const sid = process.env.TWILIO_ACCOUNT_SID || 'ACxxxxxxxx'; const token = process.env.TWILIO_AUTH_TOKEN || 'tok'; const svc = process.env.TWILIO_SERVICE_SID || 'VAXXXXX'; const client = Twilio(sid, token); try { const check = await client.verify.v2.services(svc).verificationChecks.create({ to: phone, code }); if (check.status !== 'approved') return NextResponse.json({ message:'invalid code' }, { status:401 }); await connectDB(); let user = await User.findOne({ phone }); if (!user) { user = new User({ username: 'user_' + Date.now().toString().slice(-6), phone, password: Date.now().toString() + Math.random().toString().slice(2) }); await user.save() } const tokenJwt = jwt.sign({ sub: user._id.toString(), username: user.username }, process.env.NEXTAUTH_SECRET || 'devsecret', { expiresIn: '7d' }); return NextResponse.json({ token: tokenJwt, user: { id: user._id.toString(), username: user.username, phone: user.phone } }) } catch (e) { return NextResponse.json({ message:'twilio error', error: String(e) }, { status:500 }) } }
